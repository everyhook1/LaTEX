<front><article-meta>
<title-group>
<article-title>
A digital framework to build,  visualize and analyze a gene expression atlas with cellular resolution in zebrafish early embryogenesis</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
 Carlos CastroGonzalez</contrib>
</contrib-group>
1 , 2 , 3 , Miguel A. LuengoOroz1 , 2 , Louise Duloquin4 , 5 , 6 , Thierry Savy4 , 5 , 6 , Barbara Rizzi4 , 5 , 6 , Sophie Desnoulez4 , 6 , ReneDoursat5 , 6 , 7 , Yannick L. Kergosien4 , 6 , 8 , Maria J. LedesmaCarbayo1 , 2 , Paul Bourgine4 , 5 , 6 , Nadine Peyrieras4 , 5 , 6 , ast, , Andres Santos1 , 2 , ast, <emph type="bold">1 </emph>Biomedical Image Technologies, ETSIT, Universidad Politecnica de Madrid, CEIMoncloa, Madrid, Spain<emph type="bold">2 </emph>Research Center in Bioengineering, Biomaterials and NanomedicineCIBERBBN, Madrid, Spain<emph type="bold">3 </emph>MadridMIT M Vision Consortium, Massachusetts Institute of Technology, Cambridge, Massachusetts, USA<emph type="bold">4 </emph>MDAM UPR3294, Institut de Neurobiologie Alfred Fessard, CNRS, GifsurYvette, France<emph type="bold">5 </emph>Institut des Systemes Complexes, Paris, France<emph type="bold">6 </emph>BioEmergencesIBiSA, Institut de Neurobiologie Alfred Fessard, CNRS, GifsurYvette, France<emph type="bold">7 </emph>School of Biomedical Engineering, Drexel University, Philadelphia, US<emph type="bold">8 </emph>LIMICSINSERM UMR 1142 , UFR SMBH, UniversiteParis 13 , Bobigny, FranceastCorresponding authors: nadine. peyrierasinaf. cnrsgif. fr, andresdie. upm. es<equ id="equ1" type="inline">
<tex>
$\dag$

</tex></equ>
These authors contributed equally to this work<abstract><title>Abstract</title><p> A gene expression atlas is an essential resource to quantify and understand the multiscale processes of embryogenesis in time and space. The automated reconstruction of a prototypic 4  D atlas for vertebrate early embryos, using multicolor fluorescence<emph type="italic">in situ</emph>hybridization with nuclear counterstain, requires dedicated computational strategies. To this goal, we designed an original methodological framework implemented in a software tool called MatchIT. With only minimal human supervision, our system is able to gather gene expression patterns observed in different<emph type="italic">analyzed embryos</emph>with phenotypic variability and map them onto a series of common 3  D<emph type="italic">templates</emph>over time, creating a 4  D atlas. This framework was used to construct an atlas composed of 6  gene expression templates from a cohort of zebrafish early embryos spanning 6  developmental stages from 4  to 6.3 hpfhours post fertilization. They included 53  specimens, 181 , 415  detected cell nuclei and the segmentation of 98  gene expression patterns observed in 3  D for 9  different genes. In addition, an interactive visualization software, AtlasIT, was developed to inspect, supervise and analyze the atlas. MatchIT and AtlasIT, including user manuals, representative datasets and video tutorials, are publicly and freely available online. </p><p>We also propose computational methods and tools for the quantitative assessment of the gene expression templates at the cellular scale, with the identification, visualization and analysis of coexpression patterns, synexpression groups and their dynamics through developmental stages. </p></abstract></article-meta></front><body><section><title>Author Summary</title><p> We propose a workflow to map the expression domains of multiple genes onto a series of 3  D templates, or atlas, during early embryogenesis. It was applied to the zebrafish at different stages between 4  and 6.3  hpf, generating 6  templates. Our system overcomes the lack of significant morphological landmarks in early development by relying on the expression of a reference genegoosecoid, <emph type="italic">gsc</emph>and nuclear staining to guide the registration of the analyzed genes. The proposed method also successfully maps gene domains from partially imaged embryos, thus allowing greater microscope magnification and cellular resolution. By using the workflow to construct a spatiotemporal database of zebrafish, we opened the way to a systematic analysis of vertebrate embryogenesis. The atlas database, together with the mapping softwareMatchIT, a custommade visualization platformAtlasIT, and stepbystep user guides are available from the S Material. We expect that this will encourage other laboratories to generate, map, visualize and analyze new gene expression datasets. </p></section><section><title>Introduction</title><p> Deciphering and integrating the genetic and cellular dynamics underlying morphogenesis and homeostasis in living systems is a major challenge of the postgenomic era. Although full genome sequencing is available for a number of animal model organisms <citref rids="ref1">1</citref>, quantitative data for the spatial and temporal expression of genes is still lacking <citref rids="ref2">2</citref>. </p><p>Remarkable advances in photonic microscopy imaging <citref rids="ref3">3</citref>,  <citref rids="ref4">4</citref>,  <citref rids="ref5">5</citref>and labeling techniques <citref rids="ref6">6</citref>allowed gathering data at all levels of a multicellular system s organization with adequate spatial and temporal resolutions. Fluorescent<emph type="italic">in situ</emph>hybridization techniques <citref rids="ref7">7</citref>, immunocytochemistry and transgenesis, combined with 3  D optical sectioning, make it now possible to assess the dynamics of gene expression throughout animal development with precision at the singlecell level. However, moving forward from databases of gene expression that contain average values at low spatiotemporal resolutionssuch as those obtained from DNA microarrays available for most model organismsto a dynamic, cellbased 4  D atlas is a major paradigm shift that requires the development of appropriate methods and tools. </p><p>In this context, the design and implementation of automated image analysis strategies to build a gene expression atlas with resolution at the cellular scale is an important methodological bottleneck towards greater biological insights <citref rids="ref8">8</citref>,  <citref rids="ref9">9</citref>. The task of assembling imaging data from cohorts of individuals, or<emph type="italic">analyzed embryos</emph>, onto a series of 3  D prototypes, or<emph type="italic">templates</emph>one per developmental stage, can be approached by finding a spatial correspondence between individuals based on registration methods, a technique used in medical imaging <citref rids="ref10">10</citref>. Yet, gathering and consolidating into a single prototype multimodal and multiscale features from different specimens that exhibit phenotypic variability remains a difficult challenge. </p><p>Recent studies on different model organisms have explored computational strategies for building atlases either by measuring cell positions to create prototypic specimens <citref rids="ref11">11</citref>,  <citref rids="ref12">12</citref>or by gathering gene expression patterns observed in cohorts of specimens <citref rids="ref13">13</citref>,  <citref rids="ref14">14</citref>,  <citref rids="ref15">15</citref>,  <citref rids="ref16">16</citref>. Yet, very few frameworks have combined both features. Long et al.  <citref rids="ref11">11</citref>collected data from 15 <emph type="italic">C. elegans</emph>specimens at the earliest larval stageL1 with 357  cellsto build a statistical 3  D atlas of nuclear center positions. <emph type="italic">C. elegans</emph>presents a number of advantages facilitating the reconstruction process. The entire organism can be imaged with resolution at the singlecell level and its cell lineage tree is stereotyped enough to allow spatiotemporal matching of different individuals at this level. The same features allowed the reconstruction of a prototypic lineage for a cohort containing six specimens of<emph type="italic">Danio rerio</emph>zebrafishembryos throughout their first 10  cell division cycles <citref rids="ref12">12</citref>. Peng et al.  <citref rids="ref15">15</citref>achieved the spatial matching of 2 , 945  adult<emph type="italic">Drosophila</emph>brains to collect the expression patterns of 470  different genes. Similarly, Lein et al.  <citref rids="ref13">13</citref>constructed a comprehensive atlas of the adult mouse brain containing about 20 , 000  gene patterns. The first gene expression atlas with resolution at the cellular scale was produced by Fowlkes et al.  <citref rids="ref14">14</citref>. They integrated 95  gene expression patterns observed at 6  different developmental stages in a total of 1 , 822  different<emph type="italic">Drosophila</emph>embryos within a common 3  D stencil. </p><p>Applying this approach to vertebrate model organisms is more difficult because of higher cell lineage variability and heterogeneous levels of gene expression within highly dynamic patterns. In addition, the reconstruction of 3  D gene expression templates at cellular scale for vertebrate species is likely to require the acquisition of partial volumes recorded at high resolution <citref rids="ref15">15</citref>from single specimens, and their precise mapping onto<emph type="italic">in toto</emph>reference specimens. The zebrafish, a vertebrate model organism increasingly used for its relevance to biomedical applications <citref rids="ref17">17</citref>, cumulates good properties for investigating the reconstruction of the multiscale dynamics of early embryogenesis. The gene regulatory networkGRNarchitecture of the zebrafish early embryonic development is under construction <citref rids="ref18">18</citref>and the embryo is easily accessible and amenable to transgenesis, multiple<emph type="italic">in situ</emph>staining and 3  D time imaging. The spatiotemporal data offered by a 4  D atlas of gene expression with resolution at the cellular level is expected to provide the necessary measurements for further modeling of the GRN dynamics and possible integration of the genetic and cellular levels of organization <citref rids="ref19">19</citref>. Such data would make the zebrafish the first vertebrate model amenable to a systemic study. However, building 3  D templates of gene expression for the zebrafish blastula and gastrula stages is especially problematic due to the lack of morphological landmarks required for the registration of patterns <citref rids="ref20">20</citref>,  <citref rids="ref21">21</citref>. </p><p>We provide a methodology to construct, visualize and analyze a gene expression atlas composed of templates at various stages of vertebrate early development. We designed, implemented and now deliver two computational frameworks, MatchIT and AtlasIT, to support the automatic mapping of 3  D gene expression patterns from different individualsthe analyzed embryosonto common reference specimensthe templateswith resolution at the cellular scale. This virtual multiplexing procedure <citref rids="ref14">14</citref>overcomes the limited number of gene products that can be jointly stained and measured in a single specimen. </p><p>MatchIT was used to produce the prototypic cartography of 9  gene expression patterns imaged from 3  D double fluorescent<emph type="italic">in situ</emph>hybridization at 6  developmental stages<emph type="bold">TableS fig:DataTable</emph>, <emph type="bold">MovieS fig:video0</emph>, <emph type="bold">Figs. S fig:sox32</emph>S fig:flh. AtlasIT was designed to interactively visualize gene coexpression patterns and their dynamics. We validated our 4  D atlas construction methodology by an automated quantitative assessment of gene patterns similarity and overlap through time. Analytical tools, such as clustering, were designed to identify morphogenetic domains and gene synexpression groups, i. e. groups of genes sharing the same spatiotemporal expression patterns. The proposed spatiotemporal atlas of zebrafish blastula and early gastrula preserves the information of the cell as the gene expressing unit, providing means for the integration of genetic and cellular data unavailable so far. </p></section><section><title>Results</title>
<section level="2" id="section4"><title> MatchIT: A workflow to build a gene expression atlas</title><p> We designed a computational framework<emph type="bold">Fig. <xref>fig:workflow</xref></emph>, going from image acquisition to image data analysis, to perform the mapping of different stained gene expression patterns onto a common prototypic model at each developmental stage<emph type="bold">Fig. S fig:rawDataMapped</emph>, thus creating a series of 3  D templates of gene expression with resolution at the cellular scale. </p><p>The processing workflow consisted of embryo staining, image data acquisitionMaterials and Methods, nuclear center detection, gene pattern segmentation, mapping of the analyzed embryos onto a template at each stage, and selection of template cells positive for the expression of specific genes. This methodology was designed to document at a sufficient spatial and temporal resolution the gene expression dynamics underlying the formation of the Spemann organizer and the embryonic axis of zebrafish early embryos. To this end, we imaged the dorsal side of fluorescently stained embryos with cellular resolution from fixed specimens about every 30 min from 4  to 6.3 hpf. The resulting 6  templates comprised a stencil of<emph type="italic">in toto</emph>3  D images of the template specimens<emph type="bold">Fig. <xref>fig:rawData</xref> a</emph>at different stages, and mappings of the partial 3  D views of the analyzed embryos<emph type="bold">Fig. <xref>fig:rawData</xref> b</emph>. </p><p>In order to integrate 3  D data into one template, our novel MatchIT tool<emph type="bold">SoftwareS fig:software1</emph>and<emph type="bold">User GuideS sec:userguide1</emph>performed the segmentation of gene expression domains, the mapping of analyzed embryos onto a common reference specimen and the identification of positive cells<emph type="bold">Fig. <xref>fig:workflow</xref></emph>and<emph type="bold">MovieS fig:video1</emph>, eventually delivering a 3  D database that summarized the genetic profile of single cells. </p>
<section level="3" id="section4"><title>Nuclear center detection</title><p> Nuclear center detection was an important preliminary step to1 compute a common referential for all the specimens that will guide the first coarse mapping, 2 keep image registration within the boundaries of a nuclear mask around the embryo, and3 quantitatively analyze gene expression domains from intracellular locations only, without taking into account extracellular space where staining is weaker. Additionally, detecting the nuclei has the advantage that it allows working at the cell level: cell clustering and cell entropy have a biological meaning, whereas working at the voxel level, although theoretically possible, does not have this biological significance. </p><p>The detection of cell nuclei was carried out by an algorithm followed by interactive supervision of the parameters through visual inspection<emph type="bold">Fig. <xref>fig:rawData</xref> c, e</emph>. First, nuclear centers were approximately defined at the local maxima of a smoothed, simplified version of the original image. Preprocessing consisted of convolving the image with two Gaussians of different standard deviations ranging from 2  to3 mumand 8  to14 mumrespectively, then calculating their difference and only retaining gray values greater than a threshold, which could vary between 1  and 15 </p></section>
<section level="3" id="section5"><title>Gene pattern segmentation</title><p> Our segmentation of the gene expression domains first required supervision and selection by a biologist of the lower image intensity values that best defined the domain features. MatchIT then used these parameters to perform a thresholding operation followed by morphological image processingsee Materials and Methods. The result of the expression domain segmentation was validated by visual inspection with AtlasIT prior to the identification of positive cells within the segmented domain<emph type="bold">Fig. <xref>fig:rawData</xref> d, f</emph>. Alternatively, the amount of fluorescent signal could also be used for relative quantification of gene expression within each specimen at the cellular level<emph type="bold">Fig. S fig:gene_quantification</emph>. However, a binary expression assignment, such as one provided by segmentation, was also consistent with conventional Boolean GRN modeling <citref rids="ref22">22</citref>. Cells in the analyzed embryos were identified as positive for the expression of a given gene if their approximate nuclear centers were located at less than half the average internuclear distance<emph type="bold">Fig. S fig:cellDensity</emph>from the border of the segmented expression domain. </p></section>
<section level="3" id="section6"><title>Embryo mapping</title><p> Mapping the partial 3  D volumes of the analyzed embryos onto one template involved matching the embryos common referential, their blastoderm contours and their<emph type="italic">gsc</emph>positive domains<emph type="bold">Fig. <xref>fig:referentialAxis</xref> ad</emph>. The mapping procedure was a twostep process. First, initialization was based on the automated identification of a common referential<emph type="bold">Fig. <xref>fig:referentialAxis</xref> a, b</emph>defined by two orthogonal planes<equ id="equ2" type="inline">
<tex>
$P_1$

</tex></equ>
and<equ id="equ3" type="inline">
<tex>
$P_2$

</tex></equ>
. Plane<equ id="equ4" type="inline">
<tex>
$P_1$

</tex></equ>
separated the blastoderm from the yolk at the level of the blastoderm margin, while<equ id="equ5" type="inline">
<tex>
$P_2$

</tex></equ>
was the bilateral symmetry plane containing both the center of the embryo s spherical approximation and the center of mass of the<emph type="italic">gsc</emph>positive nucleus population, <equ id="equ6" type="inline">
<tex>
$C$

</tex></equ>
see Materials and Methods. These two planes unequivocally defined a threevector basis comprising the animalvegetal axisveca, the dorsoventral axisvecdand the perpendicular vectorveclgiven by the righthanded trihedron. The origin<equ id="equ7" type="inline">
<tex>
$O$

</tex></equ>
of the reference frame was obtained by projecting<equ id="equ8" type="inline">
<tex>
$C$

</tex></equ>
on<equ id="equ9" type="inline">
<tex>
$P_1$

</tex></equ>
and, with the basisveca, vecd, vecl, was used to transform the analyzed embryos into the template. The result of this initialization was visually checked and, if necessary, corrected with the MatchIT graphical user interface, designed to minimize the effort of manual supervision<emph type="bold">Fig. <xref>fig:referentialAxis</xref> ad</emph>. </p><p>Second, this coarse initialization step was refined by a pixelbased registration procedure. Considering that zebrafish early embryos largely lacked the distinctive morphological features required to apply landmarkbased registration methods <citref rids="ref23">23</citref>,  <citref rids="ref15">15</citref>,  <citref rids="ref24">24</citref>, and given the partial nature of the volumes to be aligned, we opted for a rigid, pixelbased transformation scheme <citref rids="ref25">25</citref>that searched for an optimal match between dorsal blastoderm surfaces<emph type="bold">Fig. <xref>fig:referentialAxis</xref> c, d</emph>. A preliminary quantification of morphological variability was performed by estimating the embryos radial size. It showed that 95 </p></section>
<section level="3" id="section7"><title>Positive template cell selection</title><p> Finally, the selection of positive template cells<emph type="bold">Fig. S fig:positiveCells</emph>was performed using the same rule described for the identification of positive cells in the analyzed embryos. The number<equ id="equ10" type="inline">
<tex>
$N_i$

</tex></equ>
of cells positive for the expression of gene<equ id="equ11" type="inline">
<tex>
$i$

</tex></equ>
in an analyzed embryo differed from the number<equ id="equ12" type="inline">
<tex>
$M_i$

</tex></equ>
of cells selected as positive in the template after the mapping procedure. Independently from the fluctuations in the mapping procedure mentioned above, this difference was interpreted as resulting from individual variations in terms of internuclear distance and embryo shape, which can reflect staging misalignments<emph type="bold">Fig. S fig:method_variability</emph>. </p></section>
<section level="2" id="section9"><title>AtlasIT: A visualization tool for a gene expression atlas</title><p> Analysis of the 3  D templates produced by MatchIT required dedicated visualization tools to test hypotheses and derive biological insights. The available software kits did not fulfill our requirements, either because they were too specific for a given model organismsuch as PointCloudXplore <citref rids="ref26">26</citref>for<emph type="italic">Drosophila</emph>or because they were too generic as visualization and processing toolssuch as Icy <citref rids="ref27">27</citref>, Vaa3D <citref rids="ref28">28</citref>, or CellProfiler <citref rids="ref29">29</citref>and did not allow displaying selections of individual cellular positions or querying a template for coexpression domains with resolution at the cellular scale. </p><p>For these reasons, we designed, developed and deliver here the AtlasIT interactive visualization interface<emph type="bold">Fig. <xref>fig:virtualMultiplex</xref> a</emph>and<emph type="bold">SoftwareS fig:software2</emph>and<emph type="bold">User GuideS sec:userguide2</emph>to explore 4  D atlas resources. With this tool, we can interact with the complete atlas data, in particular superimpose raw imageseither as 3  D volumes or orthoslices, segmented patterns, and the whole set of detected template nuclei or selected positive nuclei at any time point<emph type="bold">MovieS fig:video2</emph>. AtlasIT can be used to assess the dynamics of gene coexpression domains or the variability of gene expression patterns. </p></section>
<section level="2" id="section10"><title>A spatiotemporal atlas of the zebrafish early embryo</title><p> We used MatchIT and AtlasIT together to reconstruct a 4  D atlas of zebrafish early embryogenesis, which is now released. It comprises 6  developmental stages and 9  gene expression patterns chosen to study a specific embryological question, namely the genetic dynamics underlying the formation of the Spemann organizer at the dorsal midline <citref rids="ref1">1</citref>a region in the zebrafish containing precursors of the segregation between the prechordal plate and the notochord <citref rids="ref30">30</citref>. The 9  genes are:<emph type="italic">gsc</emph>, <emph type="italic">sox32</emph>, <emph type="italic">tbx16</emph>, <emph type="italic">oep</emph>, <emph type="italic">snai1a</emph>, <emph type="italic">foxa2</emph>, <emph type="italic">ntla</emph>, <emph type="italic">flh</emph>, and<emph type="italic">egfp</emph>, where the latter was was detected in a custommade transgenic line Tg4 <emph type="italic">gsc</emph><emph type="italic">egfp</emph>isc3. These genes appear as nodes in the axial mesendoderm GRN proposed by Chan et al.  <citref rids="ref18">18</citref>. In addition, <emph type="italic">egfp</emph>allowed us to validate the transgenic line as a faithful reporter of early<emph type="italic">gsc</emph>gene expression<emph type="bold">Fig. S fig:gscegfp</emph>. The time series of 3  D templates was chosen to explore gene expression dynamics from the onset of zygotic activation at 3 hpf until early gastrulation, and encompasses the following developmental stages: sphere4 hpf, dome4.3 hpf, 30 </p></section>
<section level="2" id="section11"><title>Validation of the atlas to assess the relationships between gene patterns</title><p> The atlas was constructed to be able to compare gene expression patterns from different stained specimens. Establishing spatial relationships between gene patterns required assessing gene expression variability and calculating mean expression domainsMaterials and Methods. The expectation was that the spatial relationships observed between two genes stained in the same embryo should be maintained between their mean expression domains in a template. The expression of<emph type="italic">gsc</emph>was revealed in 9  different specimens, which comprised 8  analyzed embryos and one template, at each developmental stage. It provided a paradigmatic case to calculate a mean expression domain and assess gene variability<emph type="bold">Fig. S fig:gsc_variability</emph>. At any given stage, we quantified the mean distance from the complete outer surface of each individual<emph type="italic">gsc</emph>domain<equ id="equ13" type="inline">
<tex>
$gsc_j$

</tex></equ>
to the closest boundary point of the mean domaingsc_mathrmmean, following a leaveoneout protocol<emph type="bold">Fig. <xref>fig:virtualMultiplex</xref> b</emph>. The measured distance, which reflected both the accuracy of our mapping scheme and the interindividual variability between the boundaries of the<emph type="italic">gsc</emph>expression domains, was on average less than12 mum, i. e. approximately one cell diameter<emph type="bold">Fig. S fig:registration_validation</emph>. This accuracy error remained within the same range independently from the thickness of the three main embryo planes<emph type="bold">Fig. S fig:hausdorff_axes</emph>. Additionally, more than 80 </p><p>To demonstrate that this level of accuracy was maintained in regions far from the<emph type="italic">gsc</emph>expression domains, we replicated the same quality measure with another gene, <emph type="italic">tbx16</emph>, which spread across a much larger area than<emph type="italic">gsc</emph>. With MatchIT, we added two new<emph type="italic">tbx16</emph>datasets, <emph type="italic">tbx16</emph>band<emph type="italic">tbx16</emph>c, to the already existing<emph type="italic">tbx16</emph>aexpression in the atlas at 6.3 hpf<emph type="bold">Fig. S fig:registration_validation2</emph>a. The mean distance from the complete outer surface of each individual<emph type="italic">tbx16</emph>jdomain to the closest boundary point of<emph type="italic">tbx16</emph>mathrmmeanremained under one cell diameter<emph type="bold">Fig. S fig:registration_validation2</emph>b. Moreover, the histogram of distances between border points of<emph type="italic">tbx16</emph>jand<emph type="italic">tbx16</emph>mathrmmeanconfirmed that most of the expression contours lay within two cell rows from each other<emph type="bold">Fig. S fig:registration_validation2</emph>c. Note that this quality measure was an upper bound of the registration quality reflecting both the mapping variability and the intrinsic interembryo variability. </p><p>Additionally, we confirmed that the spatial relationships between every gene and the<equ id="equ14" type="inline">
<tex>
$gsc_j$

</tex></equ>
patterns in the analyzed embryos were the same in each template with respect to thegsc_mathrmmeandomain. In particular, this was the case for the<emph type="italic">oep</emph><emph type="italic">gsc</emph>pair illustrated in<emph type="bold">Fig. <xref>fig:virtualMultiplex</xref> c, d</emph>. </p></section>
<section level="2" id="section12"><title>Analyzing a gene expression atlas with dedicated tools</title><p> Various analysis tools for the quantitative analysis of a spatiotemporal atlas of gene expression were also developedsee Materials and Methods. We performed an automated identification of gene coexpression pattern dynamics in space and time, explored clustering strategies at the cellular level to automatically identify morphogenetic domains or spatiotemporal gene synexpression groups, and introduced an entropy analysis for gene expression. </p></section>
<section level="3" id="section12"><title>Coexpression dynamics</title><p> Coexpression between gene patterns was systematically analyzed across the atlas for all 36  possible gene pairs and 6  developmental stages. At each time point, we measured the number of cells that expressed a given pair of genes with respect to the total number of positive cells for each of the pair components. This quantification was used to construct a coexpression matrix<emph type="bold">Fig. <xref>fig:atlas_analysis</xref> a</emph>and document the pairwise evolution of gene coexpression with unprecedented temporal and spatial resolution. Alternatively, the evolution over time of the topological relationships between two gene patterns, which could be identity, inclusion, exclusion or intersection, was displayed as a trajectory in 2  D space<emph type="bold">Fig. S fig:gene_interactions36</emph>. For example, the<emph type="italic">oep</emph>and<emph type="italic">sox32</emph>domains went from inclusion at 4.3 hpf to intersection between 4.7  and 6 hpf to complete exclusion by 6.3 hpf. This representation highlighted as well the similarity of the<emph type="italic">gsc</emph>and<emph type="italic">egfp</emph>patterns until early gastrulation, a feature also captured by the high values of Dice s coefficient, D_A, B2  AbigcapBA B<emph type="bold">Fig. S fig:gene_pairs_overlap</emph>. The<emph type="italic">gsc</emph><emph type="italic">egfp</emph>pair achieved an average<equ id="equ15" type="inline">
<tex>
$D$

</tex></equ>
value of 0.77  over time, with a standard deviation of 0.1 , validating the transgenic line as an acceptable reporter of the<emph type="italic">gsc</emph>activity at these developmental stages. </p></section>
<section level="3" id="section13"><title>Morphogenetic domain clustering</title><p> At any given time step, we searched for potential morphogenetic domains using 3  D clustering of the cells<equ id="equ16" type="inline">
<tex>
$c_i$

</tex></equ>
according to their gene expression profile, veccig_i, 1 , . . . , g_i, 9 , without any a priori assumption about their spatial location<emph type="bold">Fig. <xref>fig:atlas_analysis</xref> b</emph>. At 6.3 hpf, the classification of the 1 , 194  positive cells resulted in the identification of 5  spatial domains with specific morphological locations associated to their particular gene expression profiles<emph type="bold">Fig. <xref>fig:atlas_analysis</xref> be</emph>and<emph type="bold">MovieS fig:video3</emph>. This clustering strategy revealed the anteroposterior and mediolateral patterning of the mesendodermal tissue at the onset of gastrulation. </p></section>
<section level="3" id="section14"><title>Synexpression groups</title><p> The identification of synexpression groups, i. e. genes with potentially the same spatial and temporal regulation of expression, was automated by hierarchically clustering the genes<equ id="equ17" type="inline">
<tex>
$g_j$

</tex></equ>
analyzed in the atlas according to the spatiotemporal similarity of their expression pattern at the single cell level, vecgjc_j, 1 , . . . , c_j, P. The 9  genes used in our atlas<emph type="italic">egfp</emph>, <emph type="italic">gsc</emph>, <emph type="italic">oep</emph>, <emph type="italic">foxa2</emph>, <emph type="italic">sox32</emph>, <emph type="italic">flh</emph>, <emph type="italic">snai1a</emph>, <emph type="italic">tbx16</emph>, <emph type="italic">ntla</emph>were clustered into 5  synexpression groups compatible with previous biological descriptions <citref rids="ref31">31</citref><emph type="bold">Fig. S fig:gene_dynamics</emph>. </p></section>
<section level="3" id="section15"><title>Gene expression entropy</title><p> We also measured the Shannon entropy of gene expression. In our atlas of 9  genes, where each cell expresses one of2  9  512 possible gene expression profiles, the entropy cannot be greater than 9  bits per cellbpc. The entropy that we measured increased rapidly from 2.2 bpc at 4 hpf to a maximum of 5.7 bpc at 4.7 hpf, then slightly decreased to 5.1 bpc at 6.3 hpf<emph type="bold">Fig. S fig:entropy_panel</emph>a. The increase in entropy may be related with the progressive increase in the number of non coexpressed genes<emph type="bold">Fig. S fig:entropy_panel</emph>b. In addition, we measured the contribution of each gene expression profile to the global entropy. During the analyzed period, regardless of the time step, only around 100  different gene profiles were expressed out of the possible 512 , and only a small number of gene profiles, between 30  and 50 , were found to be responsible for 75 </p><p>Finally, we demonstrated that the proposed clustering and entropy schemes were robust against changes in the threshold values used to segment the gene expression patterns in the atlas<emph type="bold">Fig. S fig:thresholds_robustness</emph>. In particular, we chose two genes in the atlas at 6.3 hpf:<emph type="italic">oep</emph>coexpressed with<emph type="italic">gsc</emph>and<emph type="italic">ntla</emph>expressed in a larger area than<emph type="italic">gsc</emph>. For these two expression patterns, we varied the thresholds chosen by the biologist expert bypm10</p></section></section></section><section><title>Discussion</title><p> We have designed, developed and delivered the MatchIT and AtlasIT software tools dedicated to the reconstruction, analysis and visualization of a 4  D atlas of gene expression in zebrafish early embryogenesis. The atlas comprises 6  different time points between 4  and 6.3 hpf, gathering data for 9  gene patterns into 6  different 3  D templates. </p><p>So far, the only known method delivered for the reconstruction of gene expression atlases in the zebrafish was designed by Ronneberger et al.  <citref rids="ref21">21</citref>for the brain and at late developmental stages, when a large number of morphological landmarks could already be recognized. Given the complexity of building a zebrafish brain atlas at late stages, the authors imposed strong constraints on the data in terms of staining protocols and imaging. Our own atlasing strategy was designed to map partial 3  D volumes onto whole embryos chosen as templates. Specimens were only required to display, in addition to any pattern of interest, nuclear staining for singlecell counterstain and a common gene expression pattern, <emph type="italic">gsc</emph>in the present version of the atlas, used for the registration step. This gene was chosen as a relevant marker, with early, strong and wellregionalized expression, to serve as a reference for constructing the dorsal side s gastrulation atlas. Thus we have minimal prerequisites for data format and specimen preparation, which should facilitate the introduction of new data into the atlas. In addition, our scheme could be easily adapted to other vertebrate organisms, e. g. xenopus, dogfish or lamprey, at early stages of development, when too few morphological features are available to use landmarkbased registration methods in the mapping process. The possibility of visual inspection and, if necessary, manual correction using our MatchIT graphical interface contributes to flexibility and accuracy when integrating new data into the atlas and validating the results. </p>
<section level="2" id="section18"><title>Resolution at the cellular scale</title><p> Our choice to work with a hybrid automatedsupervised method of nuclear center detection proved to be suitable for quantifying certain features of gene expression pattern dynamics at the cellular level. This opens the possibility to discuss, in terms of cell number, the overlap between gene expression patterns and their evolution in time. It also allows studying whether cell proliferation alone is enough to account for the expansion of gene expression patterns, by correlating internuclear distance and cell division, which, in zebrafish early development, happens at constant global cell volume<emph type="bold">Fig. S fig:cellProliferation</emph>. On the other hand, the resolution of the atlas at the cellular scale is a requirement to exploit the correlation between gene expression dynamics and cell lineage. Cellular resolution enables further mapping of the atlas onto digital specimens reconstructed from live<emph type="italic">in toto</emph>imaging, starting with our transgenic line. </p><p>Working at the cellular resolution was also intended to tackle the problem of gene expression quantification. Current strategies for<emph type="italic">in situ</emph>hybridization could at best provide relative measurements suitable for quantifying graded patterns and fuzzy borders within each analyzed embryo. Such a relative quantification would be readily available from our atlas<emph type="bold">Fig. S fig:gene_quantification</emph>. We expect future developments of the programmable<emph type="italic">in situ</emph>amplification technique <citref rids="ref7">7</citref>to help achieve quantification of gene expression comparable among different analyzed embryos at the cellular level. </p></section>
<section level="2" id="section19"><title>Individual variability and the atlas</title><p> The relevance of the atlas relies on its ability to represent and integrate the same information as would be obtained by inspecting different patterns in the same specimen. This depends on the accuracy of the registration strategies but most importantly on how the atlas construction scheme deals with individual variability. Every step of the mapping strategy has to cope with individual variations in terms of shape, cell number, cell density, and variability of the reference gene pattern. In this context, the choice of the template is crucial. The template should be closest to the mean of the population, based on geometric parameters and gene expression. Ideally, a multiscale model of individual variability should drive the choice of the atlas template as well as representative reference patterns or features to guide the mapping. In our case, the<emph type="italic">gsc</emph>pattern served as a guide for the registration step, based on the hypothesis that its expression is symmetric with respect to the bilateral plane. Although this is a reasonable assumption, it is an approximation that might be confronted to other features such as other reference gene patterns or additional morphological traits. The templates used in this paper were visually chosen to be the closest to the mean. Although this choice may not be fully representative of the average morphology, the concept of average is also not completely relevant for the released proofofprinciple atlas that comprises 9  specimens per developmental stage. The tools released here open the way for a broader population that could ideally produce a more representative template. </p><p>In this context, we calculated a mean<emph type="italic">gsc</emph>expression pattern after registering the domains from 9  different specimens. The resultinggsc_mathrmmeandomain could be subsequently used as a new reference to refine the global mappings. Moreover, all the genes gathered in the atlas could be averaged, thus preventing potentially misleading conclusions based on single specimens that might be outliers. The increase in size of the cohorts will allow exploring the possible convergence of the averaging strategy toward a single or multiple prototypical specimens. </p></section>
<section level="2" id="section20"><title>Tools for analyzing the atlas data</title><p> Atlas resources will only be fully exploited with the development and use of automated analysis methods and dedicated visualization tools. Toward this objective, we designed AtlasIT to provide a number of functionalities not available in any of the visualization tools that we examined: augmentvisualizeanalyze raw data and segmented data, calculate mean gene expression domains, gene coexpression patterns, synexpression groups, and morphogenetic domains by cell clustering. Interactive visualization and data display are essential to reveal biologically relevant information. The exploration of analytical methods to highlight spatial and temporal correlations is also a major endeavor. Typically, clustering methods have been used to establish the gene expression profiles of cells and tissues from microarray data, and more recently to group anatomical regions according to their gene expression profile <citref rids="ref13">13</citref>,  <citref rids="ref32">32</citref>,  <citref rids="ref33">33</citref>. Although clustering of spatial gene expression patterns has been described elsewhere <citref rids="ref34">34</citref>, it is the first time that this method is applied to gene expression profiles at the cellular level, x_i, y_i, z_i, t, g_i, 1 , . . . g_i, N, providing the means to reveal morphogenetic domains and synexpression groups. Additionally, whereas the Shannon entropy has been used to measure gene expression complexity <citref rids="ref35">35</citref>, it is also the first time that this measure is applied to spatially mapped data. Introducing the concept of genetic entropy in the analysis of atlas data offers a new systematic way to assess cell diversification and its underlying genetic complexity. This analysis proved to be robust against the noise due to errors in the segmentation andor spatial mapping. Although a relatively high proportion100  out of 512 of all possible gene expression profiles were found in the atlas, only 30  of themi. e. sim6</p></section>
<section level="2" id="section21"><title>Conclusion</title><p> Making a gene expression atlas is a necessary step toward the integration of multiscale and multimodal data, which should be organized, displayed and annotated to provide and share as much relevant information as possible. Developmental biology remains far behind the biomedical field in the construction and sharing of this type of resources. Thus, before reaching a consensus and establishing standards in the field, a lot remains to be explored in terms of different schemes, their flexibility, their potential and limitations. The atlas construction process presented here allowed us to address some of the most difficult biological questions linked to individual variability, its components and characteristic scales. A gene expression atlas often comprises hundreds or even thousands of genes <citref rids="ref36">36</citref>. On the other hand, resources can grow and diffuse only if deployed together with appropriate algorithms and analytical tools. Our novel construction and manipulation methods, which led to the first release of the zebrafish blastula and early gastrula atlas, are meant as a contribution toward the complete reconstruction of the zebrafish embryonic physiomeor embryomeunder different genetic and environmental conditions. </p></section></section><section><title>Materials and Methods</title>
<section level="2" id="section23"><title> In situ hybridization</title><p><emph type="italic">In vitro</emph>fertilization was used to synchronize the spawn from wild typewtor transgenic crosses from the custom made fish line Tg4  gsc:egfpisc3. Embryos, staged according to Kimmel et al.  <citref rids="ref37">37</citref>, were fixed 24  h at4 circCin PFA 4 </p></section>
<section level="2" id="section24"><title>Image data acquisition</title><p> As an input, our methodology used 3  D images acquired by confocal laser scanning microscopy from fixed zebrafish embryos with fluorescent staining of gene expression patterns and DAPI counterstain to highlight cell nuclei. Image acquisition was performed with a Leica SP2 twophotonfor DAPIand confocal laser scanning upright microscope with a Leica objective HCX APO 20  X0 , 5  W UVI or HCX APO 10  X0 , 3 . Embryos were mounted in a teflon mold at the bottom of a 3  cm Petri dish filled with 1  xPBS, 01 </p><p>The nuclei and<emph type="italic">gsc</emph>expression domains were systematically revealed in all the analyzed embryos and templates, and used to compute the gene expression mappings. In addition to the reference gene, <emph type="italic">gsc</emph>, each analyzed embryo was stained for the expression of another gene of interest. The template data was obtained by imaging the whole embryo with a 10  x objective while the analyzed specimens were imaged with a 20  x objective providing a 3  D view limited to the dorsal side of the embryo with a better spatial resolution<emph type="bold">Fig. <xref>fig:rawData</xref> a, b</emph>and<emph type="bold">MovieS fig:video0</emph>. </p><p>The fluorescent<emph type="italic">in situ</emph>hybridization used a stateoftheart protocol <citref rids="ref38">38</citref>and reproduced standard datahrefzfin. orgzfin. org. More details about data acquisition parameters and specimen features can be found in<emph type="bold">TableS fig:DataTable</emph>and<emph type="bold">Fig. S fig:sox32</emph>fig:flh. </p></section>
<section level="2" id="section25"><title>Algorithmic details of MatchIT and AtlasIT</title><p> The MatchIT custommade code was implemented in ITK and Matlab, including the MathWorks package geom3D redistributed under a BSD license. A public release of this software, together with sample datasets and a user guide, accompanies the publication of this article, </p><url url="ttp://bioemergences.iscpif.fr/documents/MatchIT.zi"></url>. <p>The segmentation of the gene expression patterns in each analyzed embryo was carried out by a thresholding operation supervised by a biologist to best define the domain features. This operation was followed by morphological closing <citref rids="ref39">39</citref>, a mathematical transformation based on a spherical structuring element the size of a typical cell diameteri. e. internuclear distance. Finally, a converse morphological opening operation left only the largest connected pattern. </p><p>The common referential extraction started by applying a spherical fit to the outer cell nuclei in all analyzed embryos and templates. The blastoderm margin was identified with a plane, <equ id="equ18" type="inline">
<tex>
$P_1$

</tex></equ>
, fitted to the 5 The registration <citref rids="ref10">10</citref>,  <citref rids="ref40">40</citref>of the analyzed embryo images on the template employed the ITK registration toolkit to optimize the crosscorrelation metric between the embryo shape of the template and that of the analyzed embryos according to a step gradient optimizer. The embryo shapes were weighted by the inverse distance function to the external blastoderm contouri. e. half the average internuclear distance away from the outermost nuclear layer. </p><p>The AtlasIT custommade visualization platform was implemented in Processing. A public release of this software, together with sample datasets and a user guide, accompanies the publication of this article, </p><url url="ttp://bioemergences.iscpif.fr/documents/AtlasIT.zi"></url></section>
<section level="2" id="section26"><title>Analysis tools for spatiotemporal gene expression atlases</title>
<section level="3" id="section26"><title><emph type="bold"> 3  D clustering of cells according to their gene expression profiles</emph></title><p>Template cells at one given developmental stage were grouped according to the similarity of their gene expression profiles using a hierarchical clustering scheme. For a given observed time<equ id="equ19" type="inline">
<tex>
$t$

</tex></equ>
, we associated a gene expression vector to each of the detected<equ id="equ20" type="inline">
<tex>
$M$

</tex></equ>
cells:veccig_i, 1 , . . . , g_i, N, whereN 9 is the number of genes under study, g_i, jis 1  if the<equ id="equ21" type="inline">
<tex>
$i$

</tex></equ>
th cell expressed the<equ id="equ22" type="inline">
<tex>
$j$

</tex></equ>
th gene, and is 0  otherwise. Then, a weighted pair group method with averagingWPGMAwas performed on these vectors based on the Euclidean distance<emph type="bold">Fig. <xref>fig:atlas_analysis</xref></emph>. This method was implemented with the Statistics toolbox of Matlab. </p></section>
<section level="3" id="section27"><title><emph type="bold">3  D time clustering of genes according to their spatiotemporal regions of expression</emph></title><p>Here the analysis involved the totality of cells across all acquisition times. For each of theN 9 genes under study, we associated a spatiotemporal expression vector:vecgjc_j, 1 , . . . , c_j, P, where<equ id="equ23" type="inline">
<tex>
$P$

</tex></equ>
is the total number of cells observed across all the observation times:Psum_k 1 6 M_k55 , 759 , with<equ id="equ24" type="inline">
<tex>
$M_k$

</tex></equ>
being the number of cells observed at the<equ id="equ25" type="inline">
<tex>
$k$

</tex></equ>
th time of acquisition. For the<equ id="equ26" type="inline">
<tex>
$j$

</tex></equ>
th gene, the<equ id="equ27" type="inline">
<tex>
$i$

</tex></equ>
th coordinate of that vector, c_j, i, was set to 1  if the<equ id="equ28" type="inline">
<tex>
$i$

</tex></equ>
th cell expressed that gene, and 0  otherwise. Clustering the genes according to their associated region of expression vectors allowed identifying synexpression groups <citref rids="ref41">41</citref>. We used the same WPGMA algorithm based on the Euclidean distance and Matlab implementation<emph type="bold">Fig. S fig:gene_dynamics</emph>. </p></section>
<section level="3" id="section28"><title><emph type="bold">Shannon entropy of gene expression</emph></title><p>We used information theory to measure an entropy for gene expression. We consider that the gene expressionvecciobserved in the<equ id="equ29" type="inline">
<tex>
$i$

</tex></equ>
th cell1 leqileqM, where<equ id="equ30" type="inline">
<tex>
$M$

</tex></equ>
is the number of cellsis the value taken by a discrete random variable<equ id="equ31" type="inline">
<tex>
$G_i$

</tex></equ>
among all possible Nuplesg_i, 1 , . . . , g_i, Nof 0  s and 1  s, i. e. all the integers in the interval0 , 2  N1 . Assuming that the random variablesG_1, . . . , G_Mare independent and identically distributed, e. g. with the same law as a given random variable<equ id="equ32" type="inline">
<tex>
$G$

</tex></equ>
, their common entropy is:HGsum_k 0 2  N1 p_k, log_2 p_k, with the usual conventions that<equ id="equ33" type="inline">
<tex>
$p_k$

</tex></equ>
denotes the probability of eventG kand we set0 , log_2 0  0 , where 2  was chosen as the base in order to express the result in bits. Each<equ id="equ34" type="inline">
<tex>
$p_k$

</tex></equ>
can be estimated from the observed samplevecc1 , . . . , veccMg_1 , 1 , . . . , g_1 , N, . . . , g_M, 1 , . . . , g_M, Nby settinghatpk n_kM, where<equ id="equ35" type="inline">
<tex>
$n_k$

</tex></equ>
is the number of template cells showing the<equ id="equ36" type="inline">
<tex>
$k$

</tex></equ>
th expression Nuple. Replacing each<equ id="equ37" type="inline">
<tex>
$p_k$

</tex></equ>
in the formula by the correspondinghatpkgives an estimate forHG. Under the same hypotheses the total entropy for the population of<equ id="equ38" type="inline">
<tex>
$M$

</tex></equ>
cells is equal toM. HG, but if the<equ id="equ39" type="inline">
<tex>
$G_i$

</tex></equ>
are not independent, the total entropy of the populationdefined using a single random variable to generate the combined expressions of all the cells in a population, and requiring the observation of several populations to permit estimationcan be less thanM. HG. </p></section>
<section level="2" id="section30"><title>Computation of the mean<emph type="italic">gsc</emph>expression domain</title><p> At each developmental time point, a total of 9  different analyzed embryos with<equ id="equ40" type="inline">
<tex>
$gsc$

</tex></equ>
staining were mapped onto the template where<equ id="equ41" type="inline">
<tex>
$gsc$

</tex></equ>
expression was also revealed. Consequently, every nucleus, <equ id="equ42" type="inline">
<tex>
$n_i$

</tex></equ>
, in the template was assigned a value, <equ id="equ43" type="inline">
<tex>
$V_i$

</tex></equ>
, ranging from 0  to 9 , depending on the number of analyzed patterns that led to its selection as positive for the expression of<equ id="equ44" type="inline">
<tex>
$gsc$

</tex></equ>
. We used a Voronoi diagram to model the cell around each nucleus and assigned these cells their corresponding value<equ id="equ45" type="inline">
<tex>
$V_i$

</tex></equ>
. In order to measure the variability of the resulting mean<equ id="equ46" type="inline">
<tex>
$gsc$

</tex></equ>
expression, we studied the profile of<equ id="equ47" type="inline">
<tex>
$V$

</tex></equ>
across 3  cutting lines centered on the mean<equ id="equ48" type="inline">
<tex>
$gsc$

</tex></equ>
centroid and following the specimen anatomy along the lateral, radial and sagittal directions respectively<emph type="bold">Fig. S fig:gsc_variability</emph>. </p></section>
<section level="2" id="section31"><title>Evaluation of the entropy and clustering robustness with respect to gene segmentation thresholds</title><p> We demonstrated that the proposed clustering and entropy schemes are robust against changes in the thresholds employed to segment the gene expression patterns in the atlas. In particular, we chose two gene expressions in the atlas at 6.3  hpf:<equ id="equ49" type="inline">
<tex>
$oep$

</tex></equ>
, which coexpresses with<equ id="equ50" type="inline">
<tex>
$gsc$

</tex></equ>
, and<equ id="equ51" type="inline">
<tex>
$ntla$

</tex></equ>
, which spreads through a much larger area than<equ id="equ52" type="inline">
<tex>
$gsc$

</tex></equ>
. For the expression of these two genes, we modified bypm10To compare the modified vs. the original clustering<emph type="bold">Fig. fig:atlas_analysis</emph>bcwe used two metrics previously employed in literature: athe correlation between the distance matrix that generate the modified and the original clustering hierarchical trees <citref rids="ref42">42</citref>, bthe cophenetic correlation, a measure of how faithfully a hierarchical tree preserves the pairwise distances between the original data points <citref rids="ref43">43</citref>,  <citref rids="ref44">44</citref>. In this later case, the cophenetic coefficient was extracted by comparing the original hierarchical tree to the new pairwise distances generated by the modified atlases. To compare the modified vs. the original entropy we computed the difference in number of bits. </p><p>The biggest difference between all the modified and the original atlas was 0.15  bits in entropy and a 0.03  decrease for both the cophenetic coefficient and the correlation between distance matrix<emph type="bold">Fig. S fig:thresholds_robustness</emph>. To put these values in perspective, the minimal possible variation to the atlaschanging the value of one gene expression for one cell onlyhad an impact of 0.0003  bits of entropy and 0.005  in cophenetic correlation, whereas a substantial variation to the atlase. g. changing one third of the atlas values or substituting it by a random atlashad an impact of 0.83  and 3.6  bits of entropy and 0.52  and 0.79  in cophenetic correlation respectively. </p></section></section></section>